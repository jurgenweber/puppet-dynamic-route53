 #!/bin/sh

# Script generated by Puppet!

# This script will either:
# 1) Create an A record in Route53 with the machines local IP or
# 2) Create a CNAME record in Route53 with the machines public hostname
# Either are dependent upon the setting that were defined in Puppet.

# Make sure only root can run our script
if [ "$(id -u)" != "0" ]; then
  echo "This script must be run as root" 1>&2
  exit 1
fi

# AWS Credentials
AWS_ACCESS_KEY_ID=<%= scope.lookupvar('dynamicroute53::aws_access_id') %>
AWS_SECRET_ACCESS_KEY=<%= scope.lookupvar('dynamicroute53::aws_secret_key') %>
export AWS_ACCESS_KEY_ID
export AWS_SECRET_ACCESS_KEY

# Get our Instance ID, local IP, and EC2 Public Hostname using cloud-utils ec2metadata
INSTANCE_ID=$(/usr/bin/ec2metadata --instance-id)
IPV4_ADDRESS=$(/usr/bin/ec2metadata --local-ipv4)
PUBLIC_HOSTNAME=$(/usr/bin/ec2metadata --public-hostname)

# Set required variables for Route53 API Call
HOSTED_ZONE_ID=<%= scope.lookupvar('dynamicroute53::hosted_zone_id') %>
DOMAIN=<%= scope.lookupvar('dynamicroute53::domain') %>
TTL=<%= scope.lookupvar('dynamicroute53::ttl') %>
REGION=<%= scope.lookupvar('dynamicroute53::region') %>

# Get our desired hostname from the "Name" tag on our instance
HOSTNAME=$(/usr/local/bin/aws ec2 describe-tags \
  --region "${REGION}" \
  --output "text" \
  --filters "Name=resource-type,Values=instance" \
            "Name=resource-id,Values=${INSTANCE_ID}" \
            "Name=key,Values=Name" \
            | awk '{print $5}' | cut -d '.' -f1)

# Begin changes
##############################################################


# Check if there is already a record for our entry and it doesn't match ours - delete it!
# This is here because otherwise we can't put in our record.
# TODO: This only checks for existing private DNS entries - not public.
# TODO: I believe list-resource-record-sets would need to be paginated if there were enough entries, which this does't support (yet).
<% if scope.lookupvar('dynamicroute53::private_dns') %>
ROUTE53_IP=$(/usr/local/bin/aws route53 list-resource-record-sets --hosted-zone-id ${HOSTED_ZONE_ID} | grep -A1 ${HOSTNAME}.${DOMAIN} | awk '{print $2}' | tail -n1)

if [ "${ROUTE53_IP}" != "${IPV4_ADDRESS}" ] && [ -n "${ROUTE53_IP}" ];
then
  /usr/local/bin/aws route53 change-resource-record-sets --region "${REGION}" --hosted-zone-id ${HOSTED_ZONE_ID} \
  --change-batch "{\"Comment\": \"string\",\"Changes\": [{\"Action\": \"DELETE\",\"ResourceRecordSet\": {\"Name\": \"${HOSTNAME}.${DOMAIN}\",\"Type\": \"A\",\"TTL\": ${TTL},\"ResourceRecords\": [{\"Value\": \"${ROUTE53_IP}\"}]}}]}"
fi
<% end %>


# Set the hostname of the machine to our EC2 Name tag & Domain.
/bin/hostname $HOSTNAME.$DOMAIN
echo $HOSTNAME.$DOMAIN > /etc/hostname

# Add FQDN to hosts file
if [ `grep -c "127.0.0.1 $HOSTNAME.$DOMAIN $HOSTNAME" /etc/hosts` -eq 0 ];
then
  echo "127.0.0.1 $HOSTNAME.$DOMAIN $HOSTNAME" >> /etc/hosts
fi

<% if scope.lookupvar('dynamicroute53::private_dns') %>
# Set an A record with the local IP

/usr/local/bin/aws route53 change-resource-record-sets --region "${REGION}" --hosted-zone-id ${HOSTED_ZONE_ID} \
  --change-batch "{\"Comment\": \"string\",\"Changes\": [{\"Action\": \"UPSERT\",\"ResourceRecordSet\": {\"Name\": \"${HOSTNAME}.${DOMAIN}\",\"Type\": \"A\",\"TTL\": ${TTL},\"ResourceRecords\": [{\"Value\": \"${IPV4_ADDRESS}\"}]}}]}"
<% else %>
# Set a CNAME record with the public hostname

/usr/local/bin/aws route53 change-resource-record-sets --region "${REGION}" --hosted-zone-id ${HOSTED_ZONE_ID} \
  --change-batch "{\"Comment\": \"string\",\"Changes\": [{\"Action\": \"UPSERT\",\"ResourceRecordSet\": {\"Name\": \"${HOSTNAME}.${DOMAIN}\",\"Type\": \"CNAME\",\"TTL\": ${TTL},\"ResourceRecords\": [{\"Value\": \"${PUBLIC_HOSTNAME}\"}]}}]}"
<% end %>
